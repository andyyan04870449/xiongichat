雄 i 聊 – 平台主動拉取同步（Pull-only）系統規格書
版本：v1.1
日期：2025-08-12 (UTC+8)
狀態：MVP 開發用正式版（可交付工程）

0. 背景與目標
服務：高雄市毒防局個案專屬聊天 AI（雄 i 聊）

目標：由市府平台主動拉取雄 i 聊的「會話、訊息、個案檔案（只讀）」以進行治理、稽核與分析；不採用平台對外 Webhook。

範圍：MVP 功能（聊天、RAG 檢索、風險偵測、個案檔案）＋對話留存與增量同步。

1. 安全與治理原則
信任邊界：所有外進/外出一律經市府 API Gateway。

通訊安全：mTLS（市府 CA 簽發，90 天輪替）、TLS1.2+。

授權模式：OAuth2 Client Credentials（細粒度 scope）。

建議 scopes：conversations.read, messages.read, profiles.read, messages.read_full（取全文時才需）

網路控管：IP allowlist（僅市府出口）、WAF、Rate Limit（預設 5 rps / consumer，600 rpm）。

資料最小化：預設回傳 content_redacted；取全文需額外 scope 並記審計事件。

審計：每請求紀錄 client_id, scopes, ip, path, params, rows, duration_ms, trace_id。

2. 資料模型（PostgreSQL）
sql
複製
編輯
-- 個案檔案（只讀給平台）
CREATE TABLE cases (
  user_id TEXT PRIMARY KEY,
  nickname TEXT,
  lang TEXT,                    -- zh-TW / en / vi / id / th...
  stage TEXT,                   -- assessment / treatment / recovery
  goals JSONB,                  -- ["維持陰性","求職",...]
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 會話（thread）
CREATE TABLE conversations (
  id UUID PRIMARY KEY,
  user_id TEXT NOT NULL,
  started_at TIMESTAMP NOT NULL DEFAULT now(),
  ended_at TIMESTAMP,
  last_message_at TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);
CREATE INDEX idx_conv_updated ON conversations(updated_at DESC);

-- 訊息
CREATE TABLE conversation_messages (
  id UUID PRIMARY KEY,
  conversation_id UUID NOT NULL REFERENCES conversations(id),
  role TEXT NOT NULL CHECK (role IN ('user','assistant','system')),
  content TEXT NOT NULL,                -- 可做應用層加密
  content_redacted TEXT,                -- 去識別/摘要
  risk_level TEXT CHECK (risk_level IN ('NONE','LOW','MEDIUM','HIGH','IMMINENT')),
  risk_categories TEXT[] DEFAULT '{}',
  rag_sources JSONB,                    -- [{title, source, date}]
  profile_snapshot JSONB,               -- 回覆當下個案快照
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);
CREATE INDEX idx_msg_conv_time ON conversation_messages(conversation_id, created_at);
CREATE INDEX idx_msg_updated  ON conversation_messages(updated_at DESC);

-- （選配）平台端同步書籤保管於雄 i 聊
CREATE TABLE sync_bookmarks (
  consumer_id TEXT PRIMARY KEY,         -- 例：'kao-main-platform'
  last_conversation_cursor TEXT,
  last_message_cursor TEXT,
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);
欄位約定

updated_at：任一筆資料被新增或變更時更新，作為增量依據。

content_redacted：脫敏規則見 §7。

3. API（供平台拉取）
Base URL：/api/v1/
通用回應標頭：X-Request-ID（平台來的）、X-Trace-ID（服務端產生）、ETag（可選）
錯誤格式：

json
複製
編輯
{ "error":"forbidden_scope", "code":"E_SCOPE", "hint":"requires messages.read_full" }
3.1 健康檢查
GET /healthz → 200 {"status":"ok","time":"2025-08-12T...+08:00"}

3.2 查會話（增量）
GET /conversations?updated_after={ISO8601}&page_size=500&cursor={opaque}&user_id=...

updated_after：ISO8601；初次可不帶（預設近 7 天）

page_size：1–1000（預設 500）

cursor：上一頁回傳的 next_cursor

範例回應

json
複製
編輯
{
  "items":[
    {
      "id":"CONV-UUID",
      "user_id":"U123",
      "started_at":"2025-08-10T02:00:00+08:00",
      "ended_at":null,
      "last_message_at":"2025-08-12T21:30:00+08:00",
      "updated_at":"2025-08-12T21:30:00+08:00"
    }
  ],
  "next_cursor":"opaque:abc...",
  "request_id":"req-123",
  "trace_id":"trace-xyz"
}
3.3 查某會話的訊息（斷點續傳）
GET /conversations/{conversation_id}/messages?after_id={MSG-ID}&limit=500&include=fields

after_id：取該 ID 之後（不含）的訊息；初次可不帶

limit：1–1000（預設 500）

include（CSV，可選）：content,profile_snapshot,rag_sources

權限：content 需 messages.read_full

範例回應

json
複製
編輯
{
  "items":[
    {
      "id":"MSG-1",
      "role":"user",
      "content_redacted":"我最近很焦慮…",
      "risk":{"level":"LOW","categories":[]},
      "created_at":"2025-08-12T21:10:00+08:00",
      "updated_at":"2025-08-12T21:10:00+08:00"
    },
    {
      "id":"MSG-2",
      "role":"assistant",
      "content_redacted":"理解你的感受，我們先做深呼吸…",
      "rag_sources":[{"title":"身心科門診資源","source":"khdpb.gov.tw","date":"2025-07-01"}],
      "profile_snapshot":{"nickname":"阿豪","lang":"zh-TW","stage":"treatment"},
      "risk":{"level":"NONE","categories":[]},
      "created_at":"2025-08-12T21:11:20+08:00",
      "updated_at":"2025-08-12T21:11:20+08:00"
    }
  ],
  "next_after_id":"MSG-2",
  "request_id":"req-123",
  "trace_id":"trace-xyz"
}
3.4 以時間窗抓訊息（跨會話增量）
GET /messages?updated_after={ISO8601}&page_size=1000&cursor=...&risk_min=MEDIUM&user_id=...&conversation_id=...&include=content

用於平台排程每 N 分鐘抓全域增量。

risk_min：NONE|LOW|MEDIUM|HIGH|IMMINENT（過濾最低風險層級）

權限：include=content 需 messages.read_full

回應同上，含 next_cursor。

3.5 讀取個案檔案
GET /profiles/{user_id}?include=fields

include 可指定 goals,stage 等

回應：

json
複製
編輯
{
  "user_id":"U123",
  "nickname":"阿豪",
  "lang":"zh-TW",
  "stage":"treatment",
  "goals":["維持陰性","求職"],
  "updated_at":"2025-08-12T20:00:00+08:00"
}
3.6（選配）平台書籤託管
GET /sync/bookmarks/{consumer_id}

PUT /sync/bookmarks/{consumer_id} body: { "last_conversation_cursor":"...", "last_message_cursor":"..." }

4. 同步流程（平台端 SOP）
初次全量

GET /conversations（分頁遍歷）

對每個 conversation_id → GET /conversations/{id}/messages（以 after_id 斷點續傳至結束）

視需要讀取 profiles/{user_id}

例行增量（每 5–15 分鐘）

優先呼叫 GET /messages?updated_after=<上次成功時間>&cursor=<上次游標>

保存 next_cursor 與成功時間到平台端的書籤表（或用 §3.6 託管）

錯誤恢復

使用上次 cursor/after_id 重試。支援 ETag/If-None-Match 減少重複下載。

5. 非功能性需求（SLA/SLO）
可用性：99.9%（健康檢查不計入）

效能：P95 延遲 ≤ 800ms／頁；page_size 建議 ≤ 1000

壓縮：伺服端強制 GZIP；HTTP/2

限流：預設 5 rps / consumer；尖峰可白名單上調

資料保存：訊息與審計 ≥ 3 年（依局方規範可調）

6. 版本與相容性
媒體型別版控（建議）：Accept: application/vnd.xiongichat.v1+json

路徑版控：/api/v1/；破壞性變更升 /v2

相容策略：新欄位以後向相容方式增加；舊欄位至少保留 12 個月

7. 脫敏（Redaction）與取全文規則
預設回傳 content_redacted：

移除/遮罩：姓名、電話、身分證、地址、金融帳號、Email、醫療敏感詞（可規則庫熱更新）。

若原文過長，保留前 200 字＋「…」；若含高風險語句，保留必要片段以便研判。

取全文：include=content + scope messages.read_full；服務端額外記一筆審計事件（誰、何時、會話/訊息、理由）。

8. 錯誤碼與範例
json
複製
編輯
// 401 未認證
{ "error":"unauthorized", "code":"E_AUTH" }

// 403 權限不足
{ "error":"forbidden_scope", "code":"E_SCOPE", "required_scope":"messages.read_full" }

// 416 時間窗過大
{ "error":"window_too_large", "code":"E_RANGE", "hint":"reduce updated_after window <= 31d" }

// 429 超過限流
{ "error":"rate_limited", "code":"E_RATELIMIT", "retry_after":"15s" }
9. 監控與對帳
指標：QPS、P95 延遲、錯誤率、吞吐量（rows/s）、成功同步量（rows/day）

審計報表：

期間內請求總數、取全文請求數、取全文請求者分佈

增量一致性：GET /metrics/sync?from=...&to=...（選配，用於與平台端對帳）

10. 上線計畫（最短路徑）
建表與索引（§2）

實作 API（§3）＋游標（opaque、包含排序鍵與隨機鹽）

mTLS 與 OAuth2（Gateway 側）

脫敏器（規則庫＋單元測試）

壓測與限流策略

平台端同步腳本驗收（全量與增量用例）

11. 驗收準則（樣例）
能在 90 天歷史範圍內於 30 分鐘內完成全量同步（平台與雄 i 聊記錄數一致±0）。

增量同步：每 5 分鐘觸發，無重複無遺漏（以 updated_after + cursor 驗證）。

權限測試：無 messages.read_full 時請求 include=content → 403。

脫敏測試：包含姓名/電話/身分證資料的訊息，content_redacted 不得露出原文。

效能：/messages?page_size=1000 P95 ≤ 800ms（測試環境資料集 ≥ 1000 萬筆）。

12. 變更紀錄
v1.1（本版）：改為 平台主動拉取；刪除所有上拋/Hook；新增時間窗與游標規格、脫敏規則與驗收準則。

v1.0：初版（含 Push/Hook 的混合方案）。
